<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Optimized Snake Game</title>
  <style>
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ecf0f1;
      transition: background-color 0.3s ease;
    }
    body.light-mode {
      background-color: #ecf0f1;
      color: #2c3e50;
    }
    #gameContainer {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      outline: none; /* Remove default focus outline */
    }
    canvas {
      background-color: #34495e;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    body.light-mode canvas {
      background-color: #bdc3c7;
      border-color: #2c3e50;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(44, 62, 80, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      border-radius: 10px;
      transition: background 0.3s ease;
    }
    body.light-mode #overlay {
      background: rgba(236, 240, 241, 0.85);
    }
    #overlay.hidden {
      display: none;
    }
    #overlay h1 {
      margin-bottom: 20px;
      font-size: 48px;
      color: #e74c3c;
    }
    #overlay p {
      font-size: 20px;
    }
    #highScore {
      margin-top: 10px;
      font-size: 18px;
    }
    #themeToggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: transparent;
      border: none;
      color: #ecf0f1;
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    body.light-mode #themeToggle {
      color: #2c3e50;
    }
    #themeToggle:focus {
      outline: none;
    }
  </style>
</head>
<body>
<button id="themeToggle" aria-label="Toggle Theme">ğŸŒ™</button>
<div id="gameContainer" tabindex="0">
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <div id="overlay">
    <!-- åˆå§‹çŠ¶æ€ä¸‹æ˜¾ç¤ºâ€œPress Space to Startâ€ -->
    <h1>Snake Game</h1>
    <p>Press <strong>Space</strong> to Start</p>
    <p>Use <strong>W</strong>, <strong>A</strong>, <strong>S</strong>, <strong>D</strong> to move</p>
    <div id="highScoreDisplay">High Score: 0</div>
  </div>
</div>

<script>
/**
 * æ¸¸æˆå¯èƒ½å¤„äºçš„çŠ¶æ€ï¼š
 * START: åˆå§‹çŠ¶æ€æˆ–æ¸¸æˆç»“æŸåï¼Œç­‰å¾…ç©å®¶æŒ‰ç©ºæ ¼å¼€å§‹
 * PLAYING: æ­£åœ¨è¿›è¡Œæ¸¸æˆ
 * PAUSED: æš‚åœä¸­
 * GAME_OVER: æ¸¸æˆç»“æŸ
 */
let gameState = 'START';

// Get DOM elements
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const gameContainer = document.getElementById('gameContainer');
const themeToggle = document.getElementById('themeToggle');
const highScoreDisplay = document.getElementById('highScoreDisplay');

// Game settings
let gridSize = 20;
let canvasWidth = canvas.width;
let canvasHeight = canvas.height;
let snake = [];
let direction = {x: 0, y: 0};
let nextDirection = {x: 0, y: 0};
let food = {x: 0, y: 0};
let gameInterval;
let gameSpeed = 150; // åˆå§‹é€Ÿåº¦
let score = 0;
let highScore = 0;
let isPaused = false;

/** åŠ è½½å­˜å‚¨çš„æœ€é«˜åˆ† */
function loadHighScore() {
  const storedHighScore = localStorage.getItem('snakeHighScore');
  if (storedHighScore !== null) {
    highScore = parseInt(storedHighScore, 10);
    updateHighScore();
  }
}

/** æ›´æ–°æœ€é«˜åˆ†æ˜¾ç¤º */
function updateHighScore() {
  highScoreDisplay.textContent = `High Score: ${highScore}`;
}

/** ç”Ÿæˆä¸€ä¸ªéšæœºæ–¹å‘ï¼Œç”¨äºæ¸¸æˆå¼€å§‹æ—¶ */
function getRandomDirection() {
  const directions = [
    {x: 0, y: -1}, // Up
    {x: 1, y: 0},  // Right
    {x: 0, y: 1},  // Down
    {x: -1, y: 0}, // Left
  ];
  return directions[Math.floor(Math.random() * directions.length)];
}

/** æ”¾ç½®é£Ÿç‰©ï¼Œç¡®ä¿ä½ç½®ä¸ä¸è›‡é‡å  */
function placeFood() {
  const availablePositions = [];
  for (let x = 0; x < canvasWidth / gridSize; x++) {
    for (let y = 0; y < canvasHeight / gridSize; y++) {
      if (!snake.some(segment => segment.x === x && segment.y === y)) {
        availablePositions.push({x, y});
      }
    }
  }
  if (availablePositions.length === 0) {
    // Player wins by filling the grid
    endGame(true);
    return;
  }
  const randomIndex = Math.floor(Math.random() * availablePositions.length);
  food = availablePositions[randomIndex];
}

/** ä¸»æ¸¸æˆå¾ªç¯ */
function gameLoop() {
  if (isPaused) return;

  // æ›´æ–°æ–¹å‘
  direction = nextDirection;

  // è®¡ç®—æ–°è›‡å¤´ä½ç½®
  const newHead = {
    x: snake[0].x + direction.x,
    y: snake[0].y + direction.y
  };

  // ç¢°æ’æ£€æµ‹ï¼šä¸è¾¹ç•Œæˆ–ä¸è‡ªèº«é‡å 
  if (
    newHead.x < 0 ||
    newHead.x >= canvasWidth / gridSize ||
    newHead.y < 0 ||
    newHead.y >= canvasHeight / gridSize ||
    snake.some(segment => segment.x === newHead.x && segment.y === newHead.y)
  ) {
    endGame(false);
    return;
  }

  // æ­£å¸¸ç§»åŠ¨ï¼šæŠŠæ–°å¤´æ”¾åˆ°é˜Ÿé¦–
  snake.unshift(newHead);

  // åˆ¤æ–­æ˜¯å¦åƒåˆ°é£Ÿç‰©
  if (newHead.x === food.x && newHead.y === food.y) {
    score++;
    if (score > highScore) {
      highScore = score;
      localStorage.setItem('snakeHighScore', highScore);
      updateHighScore();
    }
    placeFood();

    // æ¯ 5 åˆ†åŠ å¿«ä¸€æ¬¡é€Ÿåº¦
    if (score % 5 === 0 && gameSpeed > 50) {
      gameSpeed -= 10;
      clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, gameSpeed);
    }
  } else {
    // æœªåƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤å°¾å·´
    snake.pop();
  }

  draw();
}

/** ç»˜åˆ¶æ‰€æœ‰å…ƒç´  */
function draw() {
  // æ¸…ç©ºç”»å¸ƒ
  ctx.fillStyle = document.body.classList.contains('light-mode') 
    ? '#bdc3c7' 
    : '#34495e';
  ctx.fillRect(0, 0, canvasWidth, canvasHeight);

  // ç»˜åˆ¶é£Ÿç‰©
  ctx.fillStyle = '#e74c3c';
  ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);

  // ç»˜åˆ¶è›‡
  ctx.fillStyle = '#2ecc71';
  snake.forEach(segment => {
    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
  });

  // æ˜¾ç¤ºåˆ†æ•°
  ctx.fillStyle = document.body.classList.contains('light-mode') 
    ? '#2c3e50' 
    : '#ecf0f1';
  ctx.font = '20px Arial';
  ctx.fillText(`Score: ${score}`, 10, 25);
}

/** å¼€å§‹æˆ–é‡ç½®æ¸¸æˆ */
function init() {
  // é‡ç½®æ¸¸æˆé€Ÿåº¦
  gameSpeed = 150;
  clearInterval(gameInterval);

  // é‡ç½®åˆ†æ•°
  score = 0;
  
  // åˆå§‹åŒ–è›‡ï¼ˆåªæ”¾ä¸€ä¸ªç‚¹å³å¯ï¼‰
  snake = [
    {x: Math.floor(canvasWidth / (2 * gridSize)), y: Math.floor(canvasHeight / (2 * gridSize))}
  ];
  
  // åˆå§‹æ–¹å‘ç»™ä¸€ä¸ªéšæœºå€¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å›ºå®šä¸º{x:1,y:0}å‘å³
  direction = getRandomDirection();
  nextDirection = {...direction};

  placeFood();
  updateHighScore();

  // å¯åŠ¨æ¸¸æˆå¾ªç¯
  gameInterval = setInterval(gameLoop, gameSpeed);

  // overlay éšè—
  overlay.classList.add('hidden');
  isPaused = false;
  gameState = 'PLAYING';

  // èšç„¦ container ä»¥æ•è·é”®ç›˜äº‹ä»¶
  gameContainer.focus();
}

/** æš‚åœæ¸¸æˆ */
function pauseGame() {
  isPaused = true;
  gameState = 'PAUSED';
  overlay.classList.remove('hidden');
  overlay.innerHTML = `
    <h1>Paused</h1>
    <p>Press <strong>Space</strong> to Resume</p>
    <p>Score: ${score}</p>
    <div id="highScoreDisplay">High Score: ${highScore}</div>
  `;
}

/** æ¢å¤æ¸¸æˆ */
function resumeGame() {
  isPaused = false;
  gameState = 'PLAYING';
  overlay.classList.add('hidden');
  gameContainer.focus();
}

/** æ¸¸æˆç»“æŸæˆ–è·èƒœ */
function endGame(won) {
  clearInterval(gameInterval);
  gameState = 'GAME_OVER';
  overlay.classList.remove('hidden');
  overlay.innerHTML = `
    <h1>${won ? 'You Win!' : 'Game Over'}</h1>
    <p>Press <strong>Space</strong> to Restart</p>
    <p>Score: ${score}</p>
    <div id="highScoreDisplay">High Score: ${highScore}</div>
  `;
}

/** é”®ç›˜äº‹ä»¶ç›‘å¬ */
document.addEventListener('keydown', (e) => {
  const key = e.key.toLowerCase();

  switch (key) {
    case 'w':
      if (direction.y !== 1) nextDirection = {x: 0, y: -1};
      break;
    case 'a':
      if (direction.x !== 1) nextDirection = {x: -1, y: 0};
      break;
    case 's':
      if (direction.y !== -1) nextDirection = {x: 0, y: 1};
      break;
    case 'd':
      if (direction.x !== -1) nextDirection = {x: 1, y: 0};
      break;
    case ' ':
      // ç©ºæ ¼é€»è¾‘ï¼šæ ¹æ® gameState ä¸åŒè€Œè¡Œä¸ºä¸åŒ
      if (gameState === 'START' || gameState === 'GAME_OVER') {
        // ä»å¼€å§‹ç•Œé¢æˆ–ç»“æŸç•Œé¢è¿›å…¥æ–°ä¸€å±€
        init();
      } else if (gameState === 'PLAYING') {
        // æš‚åœ
        pauseGame();
      } else if (gameState === 'PAUSED') {
        // æ¢å¤
        resumeGame();
      }
      break;
  }
});

/** ä¸»é¢˜åˆ‡æ¢ */
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('light-mode');
  themeToggle.textContent = document.body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
  // åˆ‡æ¢ä¸»é¢˜åï¼Œé‡ç»˜ä¸€æ¬¡ç”»å¸ƒ
  draw();
});

/** çª—å£å¤§å°è‡ªé€‚åº”ï¼ˆç®€åŒ–å¤„ç†ï¼‰ */
window.addEventListener('resize', () => {
  const aspectRatio = 4 / 3; // Maintain 4:3 aspect ratio
  let newWidth = window.innerWidth * 0.8;
  let newHeight = newWidth / aspectRatio;
  if (newHeight > window.innerHeight * 0.8) {
    newHeight = window.innerHeight * 0.8;
    newWidth = newHeight * aspectRatio;
  }
  canvas.width = newWidth;
  canvas.height = newHeight;
  canvasWidth = canvas.width;
  canvasHeight = canvas.height;

  // è¿™é‡Œä»…é‡æ–°è®¡ç®— gridSize å¹¶é‡ç»˜
  // æ³¨æ„ï¼šè›‡å’Œé£Ÿç‰©åæ ‡å¹¶æœªåšç­‰æ¯”ç¼©æ”¾ï¼Œå¦‚æœæƒ³çœŸæ­£è·Ÿéšç”»å¸ƒå˜åŒ–ï¼Œéœ€è¦æ›´å¤æ‚çš„å¤„ç†
  gridSize = Math.floor(newWidth / 40);
  draw();
});

/** åˆå§‹åŒ–ï¼šåŠ è½½æœ€é«˜åˆ† & è¿›è¡Œåˆæ¬¡ç»˜åˆ¶ */
loadHighScore();
draw();
gameContainer.focus();
</script>
</body>
</html>
